#Requires -Module ExchangeOnlineManagement
<#
.DESCRIPTION
    Lists all file types of every anti-malware policies in Exchange Online. 
    The script compares the file types of the anti-malware policy with Microsoft's best practices.
    Source: https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-malware-protection-about?view=o365-worldwide
.INPUTS
    None. 
.OUTPUTS
    CSV with all configured Exchange Online Malware policy file types compared to Microsoft best practices. 
.NOTES
    Author: Loris Ambrozzo
    Version: 1.0
    Date: 21.03.2023
.ROLE
   Security reader role in Azure Active Directory
#>

#Define Microsoft best practices
$bestPractices = @("ace", "apk", "app", "appx", "ani", "arj", "bat", "cab", "cmd", "com", "deb", "dex", "dll", "docm", "elf", "exe", "hta", "img", "iso", "jar", 
"jnlp", "kext", "lha", "lib", "library", "lnk", "lzh", "macho", "msc", "msi", "msix", "msp", "mst", "pif", "ppa", "ppam", "reg", "rev", "scf", "scr", "sct", "sys", "uif", "vb", 
"vbe", "vbs", "vxd", "wsc", "wsf", "wsh", "xll", "xz", "z","7z", "7zip", "a", "accdb", "accde", "action", "ade", "adp", "appxbundle", "asf", "asp", "aspx", "avi", "bin", "bundle", 
"bz", "bz2", "bzip2", "cab", "caction", "cer", "chm", "command", "cpl", "crt", "csh", "css", "der", "dgz", "dmg", "doc", "docx", "dot", "dotm", "dtox", "dylib", "font", "gz", "gzip", 
"hlp", "htm", "html", "imp", "inf", "ins", "ipa", "isp", "its", "jnlp", "js", "jse", "ksh", "lqy", "mad", "maf", "mag", "mam", "maq", "mar", "mas", "mat", "mav", "maw", "mda", "mdb", 
"mde", "mdt", "mdw", "mdz", "mht", "mhtml", "mscompress", "msh", "msh1", "msh1xml", "msh2", "msh2xml", "mshxml", "msixbundle", "o", "obj", "odp", "ods", "odt", "one", "onenote", "ops",
"package", "pages", "pbix", "pdb", "pdf", "php", "pkg", "plugin", "pps", "ppsm", "ppsx", "ppt", "pptm", "pptx", "prf", "prg", "ps1", "ps1xml", "ps2", "ps2xml", "psc1", "psc2", "pst",
"pub", "py", "rar", "rpm", "rtf", "scpt", "service", "sh", "shb", "shtm", "shx", "so", "tar", "tarz", "terminal", "tgz", "tool", "url", "vhd", "vsd", "vsdm", "vsdx", "vsmacros",
"vss", "vssx", "vst", "vstm", "vstx", "vsw", "workflow", "ws", "xhtml", "xla", "xlam", "xls", "xlsb", "xlsm", "xlsx", "xlt", "xltm", "xltx", "zi", "zip", "zipx")

#Connect to Exchange Online
Connect-ExchangeOnline

#Create csv-file with headers, if "Reports" folder not exists, folder must be created manually
$file = "C:\Reports\AntiMalwareProtection_Policies.csv"
$header = "Filetype,Status,Description,Policy-Name"
Set-Content $file -Value $header

#Get all Malware Filter Policies
$malwareFilterPolicies = Get-MalwareFilterPolicy -Identity *

#Loop through each MalwareFilterPolicy 
foreach ($malwareFilterPolicy in $malwareFilterPolicies){

    #Compare best practices with implemented polices
    $compareResult = Compare-Object -ReferenceObject $bestPractices -DifferenceObject $malwareFilterPolicy.FileTypes -IncludeEqual

    #Add result to csv 
    foreach ($result in $compareResult) {
        if ($result.SideIndicator -eq "==") {
            "{0},{1},{2},{3}" -f $result.InputObject, "Ok", "Implemented and Microsoft best practices", $malwareFilterPolicy.Name | Add-Content -Path $file
        }
        elseif ($result.SideIndicator -eq "<=") {
            "{0},{1},{2},{3}" -f $result.InputObject, "NotOk", "Not implemented but Microsoft best practices", $malwareFilterPolicy.Name| Add-Content -Path $file
        }
        elseif ($result.SideIndicator -eq "=>") {
            "{0},{1},{2},{3}" -f $result.InputObject, "ToCheck", "Self-created file type", $malwareFilterPolicy.Name | Add-Content -Path $file
        } 
    }
}

#Disconnect from Exchange Online without confirmation prompt
Disconnect-ExchangeOnline -Confirm:$false